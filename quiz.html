<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizFlow - Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050507;
            --bg-2: #0a0a0f;
            --surface: rgba(255,255,255,0.03);
            --surface-hover: rgba(255,255,255,0.06);
            --border: rgba(255,255,255,0.08);
            --border-hover: rgba(139,92,246,0.5);
            --accent: #8b5cf6;
            --accent-2: #6366f1;
            --accent-grad: linear-gradient(135deg, #8b5cf6, #6366f1);
            --accent-glow: 0 0 20px rgba(139,92,246,0.35);
            --success: #34d399;
            --success-light: rgba(52,211,153,0.1);
            --warning: #fbbf24;
            --danger: #f87171;
            --danger-light: rgba(248,113,113,0.1);
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --text-dim: #475569;
            --radius: 16px;
            --radius-sm: 10px;
            --shadow: 0 25px 50px rgba(0,0,0,0.6);
            --card-shadow: 0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            position: relative;
        }
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.07;
            pointer-events: none;
            animation: drift 14s ease-in-out infinite alternate;
            z-index: 0;
        }
        body::before {
            width: 700px; height: 700px;
            background: #8b5cf6;
            top: -300px; left: -300px;
        }
        body::after {
            width: 600px; height: 600px;
            background: #6366f1;
            bottom: -200px; right: -200px;
            animation-delay: -7s;
        }
        @keyframes drift {
            from { transform: translate(0,0) scale(1); }
            to   { transform: translate(50px,40px) scale(1.1); }
        }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes shimmer {
            0%   { background-position: -400% center; }
            100% { background-position:  400% center; }
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes scoreIn {
            from { stroke-dashoffset: 339; }
        }

        .quiz-wrapper {
            max-width: 760px;
            margin: 0 auto;
            padding: 0 1.5rem 4rem;
            position: relative;
            z-index: 1;
        }

        /* â”€â”€ Sticky Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(5,5,7,0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 0;
        }
        .quiz-title-bar {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }
        .timer {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .timer.amber { color: var(--warning); }
        .timer.red   { color: var(--danger); animation: pulse 1s ease-in-out infinite; }

        /* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .progress-track {
            height: 4px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #6366f1, #8b5cf6);
            background-size: 200% 100%;
            transition: width 0.45s ease;
            width: 0%;
            animation: shimmer 3s linear infinite;
        }

        /* â”€â”€ Question Counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .question-counter {
            font-size: 0.78rem;
            color: var(--text-dim);
            font-weight: 600;
            margin-bottom: 1.25rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        /* â”€â”€ Question Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .question-card {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            animation: fadeUp 0.4s ease forwards;
        }
        .question-text {
            font-size: 1.15rem;
            font-weight: 500;
            line-height: 1.7;
            color: var(--text);
            margin-bottom: 1.75rem;
        }

        /* â”€â”€ Options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .options {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }
        .option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.9rem 1.1rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 999px;
            cursor: pointer;
            transition: border-color 0.25s, background 0.25s, box-shadow 0.25s, transform 0.15s;
            user-select: none;
        }
        .option:hover {
            border-color: var(--border-hover);
            background: rgba(139,92,246,0.06);
            box-shadow: 0 0 12px rgba(139,92,246,0.15);
            transform: translateX(2px);
        }
        .option.selected {
            border-color: var(--accent);
            background: rgba(139,92,246,0.1);
            box-shadow: 0 0 0 1px rgba(139,92,246,0.4), 0 0 16px rgba(139,92,246,0.2);
        }
        .option-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1.5px solid rgba(255,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
            color: var(--text-dim);
            transition: border-color 0.25s, background 0.25s, color 0.25s;
        }
        .option.selected .option-circle {
            background: var(--accent-grad);
            border-color: transparent;
            color: #fff;
            box-shadow: var(--accent-glow);
        }
        .option-text {
            font-size: 0.93rem;
            color: var(--text);
            line-height: 1.5;
        }

        /* â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.25s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        .btn-ghost:hover:not(:disabled) {
            background: var(--surface-hover);
            color: var(--text);
            border-color: rgba(255,255,255,0.15);
        }
        .btn-ghost:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-primary {
            background: var(--accent-grad);
            color: #fff;
            border: none;
            box-shadow: var(--accent-glow);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 28px rgba(139,92,246,0.5);
        }

        /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 65vh;
            gap: 1.5rem;
            color: var(--text-muted);
            animation: fadeUp 0.5s ease forwards;
        }
        .loading-logo {
            width: 56px; height: 56px;
            background: var(--surface);
            border: 1px solid var(--border-hover);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1.8s ease-in-out infinite;
            box-shadow: var(--accent-glow);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(139,92,246,0.15);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.85s linear infinite;
        }
        .loading-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .results-screen {
            display: none;
            padding: 2.5rem 0;
            animation: fadeUp 0.5s ease forwards;
        }
        .score-circle-wrap {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        /* SVG ring */
        .score-ring-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0 auto 1.25rem;
        }
        .score-ring-svg {
            transform: rotate(-90deg);
            overflow: visible;
        }
        .score-ring-bg {
            fill: none;
            stroke: rgba(255,255,255,0.06);
            stroke-width: 8;
        }
        .score-ring-fill {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 339.29;
            stroke-dashoffset: 339.29;
            transition: stroke-dashoffset 1.2s cubic-bezier(0.4,0,0.2,1), stroke 0.3s;
        }
        .score-ring-fill.excellent { stroke: var(--success); }
        .score-ring-fill.poor      { stroke: var(--danger); }
        .score-ring-fill.average   { stroke: var(--warning); }
        .score-ring-fill.good      { stroke: var(--accent); }

        .score-ring-inner {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .score-pct {
            font-size: 2.1rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.03em;
        }
        .score-pct.excellent { color: var(--success); }
        .score-pct.poor      { color: var(--danger); }
        .score-pct.average   { color: var(--warning); }
        .score-pct.good      { color: var(--accent); }
        .score-fraction {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
            font-weight: 500;
        }

        .score-feedback {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
            letter-spacing: -0.01em;
        }
        .score-pill {
            display: inline-block;
            padding: 0.3rem 0.9rem;
            border-radius: 999px;
            font-size: 0.82rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .score-pill.excellent { background: rgba(52,211,153,0.12); color: var(--success); }
        .score-pill.poor      { background: rgba(248,113,113,0.12); color: var(--danger); }
        .score-pill.average   { background: rgba(251,191,36,0.12);  color: var(--warning); }
        .score-pill.good      { background: rgba(139,92,246,0.12);  color: var(--accent); }

        .results-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }

        /* â”€â”€ Breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .breakdown-title {
            font-size: 0.72rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .breakdown-item {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .breakdown-item.correct { border-left: 3px solid var(--success); }
        .breakdown-item.wrong   { border-left: 3px solid var(--danger); }
        .breakdown-item.skipped { border-left: 3px solid var(--text-dim); }
        .breakdown-q {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            line-height: 1.55;
        }
        .breakdown-answers { display: flex; flex-direction: column; gap: 0.35rem; }
        .breakdown-answer {
            font-size: 0.82rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tick { color: var(--success); }
        .cross { color: var(--danger); }
        .answer-label { color: var(--text-dim); }

        @media (max-width: 600px) {
            .quiz-wrapper { padding: 0 1rem 3rem; }
            .question-card { padding: 1.5rem; }
            .quiz-controls { flex-direction: column-reverse; }
            .quiz-controls .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="quiz-wrapper">
        <!-- Top bar -->
        <div class="top-bar" id="top-bar">
            <div class="quiz-title-bar" id="quiz-title">Loading...</div>
            <div class="timer" id="timer">00:00</div>
        </div>

        <!-- Progress bar -->
        <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <!-- Loading screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-logo">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
                    <path d="M13 2L4.5 13.5H11L10 22L19.5 10.5H13L13 2Z" fill="url(#llg)" stroke="url(#llg)" stroke-width="1.2" stroke-linejoin="round"/>
                    <defs>
                        <linearGradient id="llg" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#8b5cf6"/><stop offset="1" stop-color="#6366f1"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading your quiz...</p>
        </div>

        <!-- Active quiz content -->
        <div id="quiz-content" style="display:none;">
            <div class="question-counter" id="question-counter">Question 1 of 10</div>
            <div class="question-card">
                <div class="question-text" id="question-text"></div>
                <div class="options" id="options"></div>
            </div>
            <div class="quiz-controls" id="quiz-controls">
                <button class="btn btn-ghost" id="prev-btn" onclick="previousQuestion()" disabled>â† Previous</button>
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">Next â†’</button>
            </div>
        </div>

        <!-- Results screen -->
        <div id="results-screen" class="results-screen">
            <div class="score-circle-wrap">
                <div class="score-ring-container">
                    <svg class="score-ring-svg" width="160" height="160" viewBox="0 0 120 120">
                        <circle class="score-ring-bg" cx="60" cy="60" r="54"/>
                        <circle class="score-ring-fill" id="score-ring-fill" cx="60" cy="60" r="54"/>
                    </svg>
                    <div class="score-ring-inner">
                        <div class="score-pct" id="score-pct">0%</div>
                        <div class="score-fraction" id="score-fraction">0/0</div>
                    </div>
                </div>
                <div class="score-feedback" id="score-feedback"></div>
                <div id="score-pill-wrap"></div>
            </div>
            <div class="results-actions">
                <a href="login.html" class="btn btn-ghost">Take Another Quiz</a>
            </div>
            <div class="breakdown-title">Question Breakdown</div>
            <div id="breakdown-list"></div>
        </div>
    </div>

    <script>
        let studentName = sessionStorage.getItem('studentName');
        let quizCode = sessionStorage.getItem('quizCode');

        if (!studentName || !quizCode) {
            studentName = 'Demo Student';
            quizCode = 'DEMO123';
            sessionStorage.setItem('studentName', studentName);
            sessionStorage.setItem('quizCode', quizCode);
            sessionStorage.setItem('studentEmail', 'demo@example.com');
            sessionStorage.setItem('authToken', 'demo-authorized');
            sessionStorage.setItem('demoMode', 'true');
        }

        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};  // questionId -> index (0-3)
        let quizStartTime = new Date();
        let timerInterval = null;
        let elapsedSeconds = 0;

        document.addEventListener('DOMContentLoaded', function() {
            loadQuiz();
        });

        async function loadQuiz() {
            try {
                const codeParam = quizCode ? `?code=${encodeURIComponent(quizCode)}` : '';
                const response = await fetch(`/api/quiz${codeParam}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': sessionStorage.getItem('authToken') || '',
                        'X-Quiz-Code': quizCode
                    }
                });
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data && data.questions && data.questions.length > 0) {
                            currentQuiz = data;
                            initializeQuiz();
                            return;
                        }
                    }
                }
                throw new Error('Server response invalid');
            } catch (error) {
                console.log('Server unavailable, loading demo quiz:', error.message);
                loadDemoQuiz();
            }
        }

        function loadDemoQuiz() {
            currentQuiz = {
                title: 'Sample Commerce Quiz (Demo)',
                questions: [
                    {
                        id: 1,
                        question: 'What is the primary purpose of marketing?',
                        options: [
                            'To increase production costs',
                            'To satisfy customer needs and wants',
                            'To reduce competition',
                            'To eliminate profit margins'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 2,
                        question: 'Which of the following is NOT a factor of production?',
                        options: ['Land', 'Labor', 'Capital', 'Profit'],
                        correct_answer: 3
                    },
                    {
                        id: 3,
                        question: 'What does GDP stand for?',
                        options: [
                            'General Development Plan',
                            'Gross Domestic Product',
                            'Government Debt Program',
                            'Global Distribution Policy'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 4,
                        question: 'What is supply and demand?',
                        options: [
                            'A government regulation',
                            'An economic principle that determines prices',
                            'A type of business loan',
                            'A marketing strategy'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 5,
                        question: 'What does ROI stand for?',
                        options: [
                            'Return on Investment',
                            'Rate of Interest',
                            'Risk of Inflation',
                            'Revenue of Income'
                        ],
                        correct_answer: 0
                    }
                ]
            };
            initializeQuiz();
        }

        function initializeQuiz() {
            document.getElementById('quiz-title').textContent = currentQuiz.title || 'Quiz';
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('quiz-content').style.display = 'block';
            quizStartTime = new Date();
            startTimer();
            loadQuestion(0);
        }

        function loadQuestion(index) {
            const questions = currentQuiz.questions;
            const total = questions.length;
            if (!questions || total === 0) return;

            currentQuestionIndex = index;
            const question = questions[index];

            // Progress
            const pct = ((index) / total) * 100;
            document.getElementById('progress-fill').style.width = pct + '%';
            document.getElementById('question-counter').textContent = `Question ${index + 1} of ${total}`;

            // Question text - support both server format (question.question) and legacy (question.question_text)
            const qText = question.question || question.question_text || '';
            document.getElementById('question-text').textContent = qText;

            // Options - support both server format (options array) and legacy (option_a/b/c/d)
            let opts;
            if (question.options && Array.isArray(question.options)) {
                opts = question.options;
            } else {
                opts = [question.option_a, question.option_b, question.option_c, question.option_d];
            }

            const letters = ['A', 'B', 'C', 'D'];
            const container = document.getElementById('options');
            container.innerHTML = '';

            opts.forEach((optText, i) => {
                const el = document.createElement('div');
                el.className = 'option';
                if (userAnswers[question.id] === i) el.classList.add('selected');
                el.onclick = () => selectOption(i, el, question.id);
                el.innerHTML = `
                    <div class="option-circle">${letters[i]}</div>
                    <div class="option-text">${optText}</div>
                `;
                container.appendChild(el);
            });

            // Nav buttons
            document.getElementById('prev-btn').disabled = index === 0;
            const nextBtn = document.getElementById('next-btn');
            if (index === total - 1) {
                nextBtn.textContent = 'Submit Quiz';
            } else {
                nextBtn.textContent = 'Next â†’';
            }
        }

        function selectOption(index, element, questionId) {
            document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            element.classList.add('selected');
            userAnswers[questionId] = index;
        }

        function nextQuestion() {
            const total = currentQuiz.questions.length;
            if (currentQuestionIndex < total - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            elapsedSeconds = 0;
            const timeLimit = currentQuiz.timeLimit ? currentQuiz.timeLimit * 60 : null;
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                if (timeLimit) {
                    const remaining = timeLimit - elapsedSeconds;
                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        finishQuiz();
                        return;
                    }
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    timerEl.className = 'timer' + (remaining < 30 ? ' red' : remaining < 60 ? ' amber' : '');
                } else {
                    const m = Math.floor(elapsedSeconds / 60);
                    const s = elapsedSeconds % 60;
                    timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                }
            }, 1000);
        }

        function finishQuiz() {
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('progress-fill').style.width = '100%';

            const questions = currentQuiz.questions;
            let correct = 0;

            questions.forEach(q => {
                const userAns = userAnswers[q.id];
                const correctAns = q.correct_answer;
                // Support both index (0-3) and letter ('A'-'D') for correct_answer
                let correctIdx = typeof correctAns === 'number' ? correctAns :
                    (typeof correctAns === 'string' ? 'ABCD'.indexOf(correctAns.toUpperCase()) : null);
                if (userAns !== undefined && userAns !== null && correctIdx !== null && userAns === correctIdx) {
                    correct++;
                }
            });

            const total = questions.length;
            const pct = total > 0 ? Math.round((correct / total) * 100) : 0;

            submitResults(correct, total, pct);
            showResults(correct, total, pct);
        }

        async function submitResults(correct, total, percentage) {
            const questions = currentQuiz.questions;
            const answersArray = questions.map(q => {
                const ans = userAnswers[q.id];
                return (ans !== undefined && ans !== null) ? ans : null;
            });

            try {
                await fetch('/api/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': sessionStorage.getItem('authToken') || ''
                    },
                    body: JSON.stringify({
                        email: sessionStorage.getItem('studentEmail'),
                        name: studentName,
                        code: quizCode,
                        answers: answersArray,
                        quizStartTime: quizStartTime.toISOString(),
                        quizDurationSeconds: elapsedSeconds
                    })
                });
            } catch (error) {
                console.log('Could not submit results to server:', error.message);
            }
        }

        function showResults(correct, total, pct) {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('top-bar').style.display = 'none';
            const resultsEl = document.getElementById('results-screen');
            resultsEl.style.display = 'block';

            // SVG ring animation (circumference = 2Ï€Ã—54 â‰ˆ 339.29)
            const circumference = 339.29;
            const ring = document.getElementById('score-ring-fill');
            const gradeClass = pct >= 80 ? 'excellent' : pct < 50 ? 'poor' : pct < 65 ? 'average' : 'good';
            ring.className = 'score-ring-fill ' + gradeClass;
            const offset = circumference - (pct / 100) * circumference;
            setTimeout(() => { ring.style.strokeDashoffset = offset; }, 50);

            // Score text
            const scorePctEl = document.getElementById('score-pct');
            scorePctEl.className = 'score-pct ' + gradeClass;
            scorePctEl.textContent = pct + '%';
            document.getElementById('score-fraction').textContent = `${correct}/${total}`;

            // Feedback + pill
            let feedback, pillText;
            if (pct >= 90) { feedback = 'ğŸ‰ Excellent work!'; pillText = 'Outstanding performance'; }
            else if (pct >= 75) { feedback = 'ğŸ‘ Great job!'; pillText = 'You did really well'; }
            else if (pct >= 60) { feedback = 'ğŸ“š Good effort.'; pillText = 'Keep practicing to improve'; }
            else if (pct >= 50) { feedback = 'ğŸ˜ You passed.'; pillText = 'Review the material'; }
            else { feedback = 'ğŸ“– Keep studying.'; pillText = "Don't give up â€” review and retry"; }
            document.getElementById('score-feedback').textContent = feedback;
            document.getElementById('score-pill-wrap').innerHTML =
                `<span class="score-pill ${gradeClass}">${pillText}</span>`;

            // Detailed breakdown
            const breakdownList = document.getElementById('breakdown-list');
            breakdownList.innerHTML = '';
            const letters = ['A', 'B', 'C', 'D'];
            const questions = currentQuiz.questions;

            questions.forEach((q, idx) => {
                const qText = q.question || q.question_text || '';
                let opts = (q.options && Array.isArray(q.options)) ? q.options :
                    [q.option_a, q.option_b, q.option_c, q.option_d];
                const userAns = userAnswers[q.id];
                const correctAns = q.correct_answer;
                let correctIdx = typeof correctAns === 'number' ? correctAns :
                    (typeof correctAns === 'string' ? 'ABCD'.indexOf(correctAns.toUpperCase()) : null);

                const isSkipped = userAns === undefined || userAns === null;
                const isCorrect = !isSkipped && correctIdx !== null && userAns === correctIdx;
                const cls = isSkipped ? 'skipped' : (isCorrect ? 'correct' : 'wrong');

                const item = document.createElement('div');
                item.className = `breakdown-item ${cls}`;

                let answersHtml = '';
                if (!isSkipped) {
                    answersHtml += `<div class="breakdown-answer">
                        <span class="${isCorrect ? 'tick' : 'cross'}">${isCorrect ? 'âœ“' : 'âœ—'}</span>
                        <span class="answer-label">Your answer:</span>
                        <span>${letters[userAns]} â€” ${opts[userAns] || ''}</span>
                    </div>`;
                } else {
                    answersHtml += `<div class="breakdown-answer"><span class="cross">â€”</span><span class="answer-label">Not answered</span></div>`;
                }
                if (!isCorrect && correctIdx !== null) {
                    answersHtml += `<div class="breakdown-answer">
                        <span class="tick">âœ“</span>
                        <span class="answer-label">Correct answer:</span>
                        <span>${letters[correctIdx]} â€” ${opts[correctIdx] || ''}</span>
                    </div>`;
                }

                item.innerHTML = `
                    <div class="breakdown-q"><strong>Q${idx+1}.</strong> ${qText}</div>
                    <div class="breakdown-answers">${answersHtml}</div>
                `;
                breakdownList.appendChild(item);
            });
        }
    </script>
</body>
</html>
