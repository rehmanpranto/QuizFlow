<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizFlow - Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090b;
            --surface: #18181b;
            --surface-2: #27272a;
            --border: #3f3f46;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99,102,241,0.12);
            --success: #22c55e;
            --success-light: rgba(34,197,94,0.12);
            --warning: #f59e0b;
            --danger: #ef4444;
            --danger-light: rgba(239,68,68,0.12);
            --text: #fafafa;
            --text-muted: #a1a1aa;
            --text-dim: #52525b;
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .quiz-wrapper {
            max-width: 760px;
            margin: 0 auto;
            padding: 0 1.5rem 4rem;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 0;
        }
        .quiz-title-bar {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }
        .timer {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            transition: color 0.3s;
        }
        .timer.amber { color: var(--warning); }
        .timer.red { color: var(--danger); }

        /* Progress bar */
        .progress-track {
            height: 3px;
            background: var(--surface-2);
            margin-bottom: 2rem;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.4s ease;
            width: 0%;
        }

        /* Question counter */
        .question-counter {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 1.25rem;
            letter-spacing: 0.02em;
        }

        /* Question card */
        .question-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }
        .question-text {
            font-size: 1.15rem;
            font-weight: 500;
            line-height: 1.65;
            color: var(--text);
            margin-bottom: 1.75rem;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1rem;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        .option:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }
        .option.selected {
            border-color: var(--accent);
            background: var(--accent-light);
            box-shadow: 0 0 0 1px var(--accent);
        }
        .option-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
            color: var(--text-muted);
            transition: border-color 0.2s, background 0.2s, color 0.2s;
        }
        .option.selected .option-circle {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }
        .option-text {
            font-size: 0.95rem;
            color: var(--text);
            line-height: 1.5;
        }

        /* Navigation buttons */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        .btn-ghost:hover:not(:disabled) {
            background: var(--surface-2);
            color: var(--text);
        }
        .btn-ghost:disabled { opacity: 0.35; cursor: not-allowed; }
        .btn-primary {
            background: var(--accent);
            color: #fff;
        }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }

        /* Loading */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 1rem;
            color: var(--text-muted);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results screen */
        .results-screen {
            display: none;
            padding: 2rem 0;
        }
        .score-circle-wrap {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        .score-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 6px solid var(--accent);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            background: var(--accent-light);
        }
        .score-circle.excellent { border-color: var(--success); background: var(--success-light); }
        .score-circle.poor { border-color: var(--danger); background: var(--danger-light); }
        .score-pct {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1;
        }
        .score-circle.excellent .score-pct { color: var(--success); }
        .score-circle.poor .score-pct { color: var(--danger); }
        .score-circle:not(.excellent):not(.poor) .score-pct { color: var(--accent); }
        .score-fraction {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
        }
        .score-feedback {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
        }
        .score-sub {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .results-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }

        /* Detailed breakdown */
        .breakdown-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.75rem;
        }
        .breakdown-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .breakdown-item.correct { border-left: 3px solid var(--success); }
        .breakdown-item.wrong { border-left: 3px solid var(--danger); }
        .breakdown-item.skipped { border-left: 3px solid var(--text-dim); }
        .breakdown-q {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        .breakdown-answers {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .breakdown-answer {
            font-size: 0.825rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tick { color: var(--success); }
        .cross { color: var(--danger); }
        .answer-label { color: var(--text-dim); }

        @media (max-width: 600px) {
            .quiz-wrapper { padding: 0 1rem 3rem; }
            .question-card { padding: 1.5rem; }
            .quiz-controls { flex-direction: column-reverse; }
            .quiz-controls .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="quiz-wrapper">
        <!-- Top bar -->
        <div class="top-bar" id="top-bar">
            <div class="quiz-title-bar" id="quiz-title">Loading...</div>
            <div class="timer" id="timer">00:00</div>
        </div>

        <!-- Progress bar -->
        <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <!-- Loading screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-spinner"></div>
            <p>Loading your quiz...</p>
        </div>

        <!-- Active quiz content -->
        <div id="quiz-content" style="display:none;">
            <div class="question-counter" id="question-counter">Question 1 of 10</div>
            <div class="question-card">
                <div class="question-text" id="question-text"></div>
                <div class="options" id="options"></div>
            </div>
            <div class="quiz-controls" id="quiz-controls">
                <button class="btn btn-ghost" id="prev-btn" onclick="previousQuestion()" disabled>‚Üê Previous</button>
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">Next ‚Üí</button>
            </div>
        </div>

        <!-- Results screen -->
        <div id="results-screen" class="results-screen">
            <div class="score-circle-wrap">
                <div class="score-circle" id="score-circle">
                    <div class="score-pct" id="score-pct">0%</div>
                    <div class="score-fraction" id="score-fraction">0/0</div>
                </div>
                <div class="score-feedback" id="score-feedback"></div>
                <div class="score-sub" id="score-sub"></div>
            </div>
            <div class="results-actions">
                <a href="login.html" class="btn btn-ghost">Take Another Quiz</a>
            </div>
            <div class="breakdown-title">Question Breakdown</div>
            <div id="breakdown-list"></div>
        </div>
    </div>

    <script>
        let studentName = sessionStorage.getItem('studentName');
        let quizCode = sessionStorage.getItem('quizCode');

        if (!studentName || !quizCode) {
            studentName = 'Demo Student';
            quizCode = 'DEMO123';
            sessionStorage.setItem('studentName', studentName);
            sessionStorage.setItem('quizCode', quizCode);
            sessionStorage.setItem('studentEmail', 'demo@example.com');
            sessionStorage.setItem('authToken', 'demo-authorized');
            sessionStorage.setItem('demoMode', 'true');
        }

        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};  // questionId -> index (0-3)
        let quizStartTime = new Date();
        let timerInterval = null;
        let elapsedSeconds = 0;

        document.addEventListener('DOMContentLoaded', function() {
            loadQuiz();
        });

        async function loadQuiz() {
            try {
                const response = await fetch('/api/quiz', {
                    method: 'GET',
                    headers: {
                        'Authorization': sessionStorage.getItem('authToken') || '',
                        'X-Quiz-Code': quizCode
                    }
                });
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data && data.questions && data.questions.length > 0) {
                            currentQuiz = data;
                            initializeQuiz();
                            return;
                        }
                    }
                }
                throw new Error('Server response invalid');
            } catch (error) {
                console.log('Server unavailable, loading demo quiz:', error.message);
                loadDemoQuiz();
            }
        }

        function loadDemoQuiz() {
            currentQuiz = {
                title: 'Sample Commerce Quiz (Demo)',
                questions: [
                    {
                        id: 1,
                        question: 'What is the primary purpose of marketing?',
                        options: [
                            'To increase production costs',
                            'To satisfy customer needs and wants',
                            'To reduce competition',
                            'To eliminate profit margins'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 2,
                        question: 'Which of the following is NOT a factor of production?',
                        options: ['Land', 'Labor', 'Capital', 'Profit'],
                        correct_answer: 3
                    },
                    {
                        id: 3,
                        question: 'What does GDP stand for?',
                        options: [
                            'General Development Plan',
                            'Gross Domestic Product',
                            'Government Debt Program',
                            'Global Distribution Policy'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 4,
                        question: 'What is supply and demand?',
                        options: [
                            'A government regulation',
                            'An economic principle that determines prices',
                            'A type of business loan',
                            'A marketing strategy'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 5,
                        question: 'What does ROI stand for?',
                        options: [
                            'Return on Investment',
                            'Rate of Interest',
                            'Risk of Inflation',
                            'Revenue of Income'
                        ],
                        correct_answer: 0
                    }
                ]
            };
            initializeQuiz();
        }

        function initializeQuiz() {
            document.getElementById('quiz-title').textContent = currentQuiz.title || 'Quiz';
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('quiz-content').style.display = 'block';
            quizStartTime = new Date();
            startTimer();
            loadQuestion(0);
        }

        function loadQuestion(index) {
            const questions = currentQuiz.questions;
            const total = questions.length;
            if (!questions || total === 0) return;

            currentQuestionIndex = index;
            const question = questions[index];

            // Progress
            const pct = ((index) / total) * 100;
            document.getElementById('progress-fill').style.width = pct + '%';
            document.getElementById('question-counter').textContent = `Question ${index + 1} of ${total}`;

            // Question text - support both server format (question.question) and legacy (question.question_text)
            const qText = question.question || question.question_text || '';
            document.getElementById('question-text').textContent = qText;

            // Options - support both server format (options array) and legacy (option_a/b/c/d)
            let opts;
            if (question.options && Array.isArray(question.options)) {
                opts = question.options;
            } else {
                opts = [question.option_a, question.option_b, question.option_c, question.option_d];
            }

            const letters = ['A', 'B', 'C', 'D'];
            const container = document.getElementById('options');
            container.innerHTML = '';

            opts.forEach((optText, i) => {
                const el = document.createElement('div');
                el.className = 'option';
                if (userAnswers[question.id] === i) el.classList.add('selected');
                el.onclick = () => selectOption(i, el, question.id);
                el.innerHTML = `
                    <div class="option-circle">${letters[i]}</div>
                    <div class="option-text">${optText}</div>
                `;
                container.appendChild(el);
            });

            // Nav buttons
            document.getElementById('prev-btn').disabled = index === 0;
            const nextBtn = document.getElementById('next-btn');
            if (index === total - 1) {
                nextBtn.textContent = 'Submit Quiz';
            } else {
                nextBtn.textContent = 'Next ‚Üí';
            }
        }

        function selectOption(index, element, questionId) {
            document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            element.classList.add('selected');
            userAnswers[questionId] = index;
        }

        function nextQuestion() {
            const total = currentQuiz.questions.length;
            if (currentQuestionIndex < total - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            elapsedSeconds = 0;
            const timeLimit = currentQuiz.timeLimit ? currentQuiz.timeLimit * 60 : null;
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                if (timeLimit) {
                    const remaining = timeLimit - elapsedSeconds;
                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        finishQuiz();
                        return;
                    }
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    timerEl.className = 'timer' + (remaining < 30 ? ' red' : remaining < 60 ? ' amber' : '');
                } else {
                    const m = Math.floor(elapsedSeconds / 60);
                    const s = elapsedSeconds % 60;
                    timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                }
            }, 1000);
        }

        function finishQuiz() {
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('progress-fill').style.width = '100%';

            const questions = currentQuiz.questions;
            let correct = 0;

            questions.forEach(q => {
                const userAns = userAnswers[q.id];
                const correctAns = q.correct_answer;
                // Support both index (0-3) and letter ('A'-'D') for correct_answer
                let correctIdx = typeof correctAns === 'number' ? correctAns :
                    (typeof correctAns === 'string' ? 'ABCD'.indexOf(correctAns.toUpperCase()) : null);
                if (userAns !== undefined && userAns !== null && correctIdx !== null && userAns === correctIdx) {
                    correct++;
                }
            });

            const total = questions.length;
            const pct = total > 0 ? Math.round((correct / total) * 100) : 0;

            submitResults(correct, total, pct);
            showResults(correct, total, pct);
        }

        async function submitResults(correct, total, percentage) {
            const questions = currentQuiz.questions;
            const answersArray = questions.map(q => {
                const ans = userAnswers[q.id];
                return (ans !== undefined && ans !== null) ? ans : null;
            });

            try {
                await fetch('/api/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': sessionStorage.getItem('authToken') || ''
                    },
                    body: JSON.stringify({
                        email: sessionStorage.getItem('studentEmail'),
                        name: studentName,
                        code: quizCode,
                        answers: answersArray,
                        quizStartTime: quizStartTime.toISOString(),
                        quizDurationSeconds: elapsedSeconds
                    })
                });
            } catch (error) {
                console.log('Could not submit results to server:', error.message);
            }
        }

        function showResults(correct, total, pct) {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('top-bar').style.display = 'none';
            const resultsEl = document.getElementById('results-screen');
            resultsEl.style.display = 'block';

            // Score circle
            const circle = document.getElementById('score-circle');
            circle.className = 'score-circle' + (pct >= 80 ? ' excellent' : pct < 50 ? ' poor' : '');
            document.getElementById('score-pct').textContent = pct + '%';
            document.getElementById('score-fraction').textContent = `${correct}/${total}`;

            // Feedback
            let feedback, sub;
            if (pct >= 90) { feedback = 'üéâ Excellent work!'; sub = 'Outstanding performance.'; }
            else if (pct >= 75) { feedback = 'üëç Great job!'; sub = 'You did really well.'; }
            else if (pct >= 60) { feedback = 'üìö Good effort.'; sub = 'Keep practicing to improve.'; }
            else if (pct >= 50) { feedback = 'üòê You passed.'; sub = 'Review the material and try again.'; }
            else { feedback = 'üìñ Keep studying.'; sub = 'Don\'t give up ‚Äî review and retry.'; }
            document.getElementById('score-feedback').textContent = feedback;
            document.getElementById('score-sub').textContent = sub;

            // Detailed breakdown
            const breakdownList = document.getElementById('breakdown-list');
            breakdownList.innerHTML = '';
            const letters = ['A', 'B', 'C', 'D'];
            const questions = currentQuiz.questions;

            questions.forEach((q, idx) => {
                const qText = q.question || q.question_text || '';
                let opts = (q.options && Array.isArray(q.options)) ? q.options :
                    [q.option_a, q.option_b, q.option_c, q.option_d];
                const userAns = userAnswers[q.id];
                const correctAns = q.correct_answer;
                let correctIdx = typeof correctAns === 'number' ? correctAns :
                    (typeof correctAns === 'string' ? 'ABCD'.indexOf(correctAns.toUpperCase()) : null);

                const isSkipped = userAns === undefined || userAns === null;
                const isCorrect = !isSkipped && correctIdx !== null && userAns === correctIdx;
                const cls = isSkipped ? 'skipped' : (isCorrect ? 'correct' : 'wrong');

                const item = document.createElement('div');
                item.className = `breakdown-item ${cls}`;

                let answersHtml = '';
                if (!isSkipped) {
                    answersHtml += `<div class="breakdown-answer">
                        <span class="${isCorrect ? 'tick' : 'cross'}">${isCorrect ? '‚úì' : '‚úó'}</span>
                        <span class="answer-label">Your answer:</span>
                        <span>${letters[userAns]} ‚Äî ${opts[userAns] || ''}</span>
                    </div>`;
                } else {
                    answersHtml += `<div class="breakdown-answer"><span class="cross">‚Äî</span><span class="answer-label">Not answered</span></div>`;
                }
                if (!isCorrect && correctIdx !== null) {
                    answersHtml += `<div class="breakdown-answer">
                        <span class="tick">‚úì</span>
                        <span class="answer-label">Correct answer:</span>
                        <span>${letters[correctIdx]} ‚Äî ${opts[correctIdx] || ''}</span>
                    </div>`;
                }

                item.innerHTML = `
                    <div class="breakdown-q"><strong>Q${idx+1}.</strong> ${qText}</div>
                    <div class="breakdown-answers">${answersHtml}</div>
                `;
                breakdownList.appendChild(item);
            });
        }
    </script>
</body>
</html>
