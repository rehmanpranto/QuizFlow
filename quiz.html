<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizFlow - Take Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Page-specific styles */
        .quiz-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1.5rem 4rem;
            position: relative;
            z-index: 1;
        }

        /* Sticky Top Bar */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(5, 5, 7, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            margin-bottom: 0;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .quiz-title-bar {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quiz-title-icon {
            color: var(--accent);
        }

        .timer {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: var(--surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .timer.amber { 
            color: var(--warning); 
            background: var(--warning-bg);
            border-color: rgba(251, 191, 36, 0.3);
        }
        
        .timer.red { 
            color: var(--danger); 
            background: var(--danger-bg);
            border-color: rgba(248, 113, 113, 0.3);
            animation: pulse 1s ease-in-out infinite; 
        }

        /* Progress Bar */
        .progress-container {
            background: var(--bg-elevated);
            height: 6px;
            width: 100%;
        }

        .progress-track {
            height: 100%;
            background: var(--border);
            border-radius: 0 0 var(--radius) var(--radius);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-grad);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* Question Counter */
        .question-counter {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            margin: 1.25rem 0 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .question-counter::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
        }

        /* Question Card */
        .question-card {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            animation: fadeUp 0.4s ease forwards;
        }

        .question-text {
            font-size: 1.125rem;
            font-weight: 500;
            line-height: 1.7;
            color: var(--text);
            margin-bottom: 1.75rem;
        }

        /* Options */
        .options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
            user-select: none;
        }

        .option-card:hover {
            border-color: var(--border-hover);
            background: var(--surface-hover);
            transform: translateX(4px);
        }

        .option-card.selected {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .option-card.correct {
            border-color: var(--success);
            background: var(--success-bg);
        }

        .option-card.incorrect {
            border-color: var(--danger);
            background: var(--danger-bg);
        }

        .option-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface);
            border: 1.5px solid var(--border);
            font-size: 0.8125rem;
            font-weight: 700;
            color: var(--text-muted);
            flex-shrink: 0;
            transition: all var(--transition);
        }

        .option-card.selected .option-label {
            background: var(--accent-grad);
            border-color: transparent;
            color: #fff;
            box-shadow: var(--accent-glow);
        }

        .option-card.correct .option-label {
            background: var(--success);
            border-color: transparent;
            color: #fff;
        }

        .option-card.incorrect .option-label {
            background: var(--danger);
            border-color: transparent;
            color: #fff;
        }

        .option-text {
            flex: 1;
            font-size: 0.9375rem;
            line-height: 1.5;
            color: var(--text);
        }

        /* Quiz Controls */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-nav {
            min-width: 140px;
        }

        /* Loading Screen */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 1.5rem;
            color: var(--text-muted);
            animation: fadeUp 0.5s ease forwards;
        }

        .loading-logo {
            width: 64px;
            height: 64px;
            background: var(--surface);
            border: 1px solid var(--border-hover);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1.8s ease-in-out infinite;
            box-shadow: var(--accent-glow);
        }

        .loading-spinner-lg {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(139, 92, 246, 0.15);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.85s linear infinite;
        }

        .loading-text {
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .loading-subtext {
            font-size: 0.8125rem;
            color: var(--text-dim);
        }

        /* Results Screen */
        .results-screen {
            display: none;
            padding: 2.5rem 0;
            animation: fadeUp 0.5s ease forwards;
        }

        .score-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        /* Score Ring */
        .score-ring-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 1.5rem;
        }

        .score-ring-svg {
            transform: rotate(-90deg);
        }

        .score-ring-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 10;
        }

        .score-ring-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 1.4s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s;
        }

        .score-ring-fill.excellent { stroke: var(--success); }
        .score-ring-fill.good { stroke: var(--accent); }
        .score-ring-fill.average { stroke: var(--warning); }
        .score-ring-fill.poor { stroke: var(--danger); }

        .score-ring-inner {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .score-emoji {
            font-size: 2.5rem;
            margin-bottom: 0.25rem;
        }

        .score-pct {
            font-size: 2.25rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.03em;
        }

        .score-pct.excellent { color: var(--success); }
        .score-pct.good { color: var(--accent); }
        .score-pct.average { color: var(--warning); }
        .score-pct.poor { color: var(--danger); }

        .score-fraction {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 0.375rem;
            font-weight: 500;
        }

        .score-feedback {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.01em;
        }

        .score-pill {
            display: inline-block;
            padding: 0.375rem 1rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.75rem;
        }

        .score-pill.excellent { background: var(--success-bg); color: var(--success); }
        .score-pill.good { background: rgba(139, 92, 246, 0.15); color: var(--accent); }
        .score-pill.average { background: var(--warning-bg); color: var(--warning); }
        .score-pill.poor { background: var(--danger-bg); color: var(--danger); }

        /* Results Actions */
        .results-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }

        /* Breakdown */
        .breakdown-section {
            margin-top: 2rem;
        }

        .breakdown-title {
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breakdown-title::before {
            content: '';
            width: 24px;
            height: 1px;
            background: var(--border);
        }

        .breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .breakdown-item {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1.25rem;
            transition: all var(--transition);
        }

        .breakdown-item:hover {
            border-color: var(--border-hover);
            background: var(--surface-hover);
        }

        .breakdown-item.correct { 
            border-left: 3px solid var(--success); 
        }
        
        .breakdown-item.incorrect { 
            border-left: 3px solid var(--danger); 
        }

        .breakdown-q {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            color: var(--text);
        }

        .breakdown-answers {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .breakdown-answer {
            font-size: 0.8125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breakdown-answer-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .breakdown-answer.correct { color: var(--success); }
        .breakdown-answer.incorrect { color: var(--danger); }

        .breakdown-answer-text {
            color: var(--text-muted);
        }

        .breakdown-answer-text.selected {
            color: var(--text);
            font-weight: 500;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.98); }
        }

        /* Responsive */
        @media (max-width: 640px) {
            .quiz-wrapper { 
                padding: 0 1rem 3rem; 
            }
            
            .top-bar {
                padding: 0.75rem 1rem;
            }
            
            .quiz-title-bar {
                font-size: 0.8125rem;
                max-width: 50%;
            }
            
            .timer {
                font-size: 0.875rem;
                padding: 0.25rem 0.5rem;
            }
            
            .question-card { 
                padding: 1.5rem; 
            }
            
            .question-text {
                font-size: 1rem;
            }
            
            .quiz-controls { 
                flex-direction: column-reverse; 
            }
            
            .quiz-controls .btn { 
                width: 100%; 
                justify-content: center; 
            }
            
            .score-ring-container {
                width: 140px;
                height: 140px;
            }
            
            .score-pct {
                font-size: 1.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="quiz-wrapper">
        <!-- Top bar -->
        <div class="top-bar" id="top-bar">
            <div class="quiz-title-bar" id="quiz-title">
                <svg class="quiz-title-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span>Loading...</span>
            </div>
            <div class="timer" id="timer">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span>00:00</span>
            </div>
        </div>

        <!-- Progress bar -->
        <div class="progress-container">
            <div class="progress-track">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <!-- Loading screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-logo">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                    <path d="M13 2L4.5 13.5H11L10 22L19.5 10.5H13L13 2Z" 
                          fill="url(#llg)" stroke="url(#llg)" stroke-width="1.2" stroke-linejoin="round"/>
                    <defs>
                        <linearGradient id="llg" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#8b5cf6"/>
                            <stop offset="1" stop-color="#6366f1"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div class="loading-spinner-lg"></div>
            <p class="loading-text">Loading your quiz...</p>
            <p class="loading-subtext">Please wait a moment</p>
        </div>

        <!-- Active quiz content -->
        <div id="quiz-content" style="display:none;">
            <div class="question-counter" id="question-counter">Question 1 of 10</div>
            
            <div class="question-card">
                <div class="question-text" id="question-text"></div>
                <div class="options" id="options"></div>
            </div>
            
            <div class="quiz-controls" id="quiz-controls">
                <button class="btn btn-secondary btn-nav" id="prev-btn" onclick="previousQuestion()" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
                <button class="btn btn-primary btn-nav" id="next-btn" onclick="nextQuestion()">
                    Next
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Results screen -->
        <div id="results-screen" class="results-screen">
            <div class="score-header">
                <div class="score-ring-container">
                    <svg class="score-ring-svg" width="180" height="180" viewBox="0 0 160 160">
                        <circle class="score-ring-bg" cx="80" cy="80" r="70"/>
                        <circle class="score-ring-fill" id="score-ring-fill" cx="80" cy="80" r="70"/>
                    </svg>
                    <div class="score-ring-inner">
                        <div class="score-emoji" id="score-emoji">üéØ</div>
                        <div class="score-pct" id="score-pct">0%</div>
                        <div class="score-fraction" id="score-fraction">0/0</div>
                    </div>
                </div>
                <div class="score-feedback" id="score-feedback"></div>
                <div id="score-pill-wrap"></div>
            </div>
            
            <div class="results-actions">
                <a href="login.html" class="btn btn-primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Take Another Quiz
                </a>
                <button class="btn btn-secondary" onclick="window.print()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 6 2 18 2 18 9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                    Print Results
                </button>
            </div>
            
            <div class="breakdown-section">
                <div class="breakdown-title">Question Breakdown</div>
                <div class="breakdown-list" id="breakdown-list"></div>
            </div>
        </div>
    </div>

    <script>
        let studentName = sessionStorage.getItem('studentName');
        let quizCode = sessionStorage.getItem('quizCode');

        if (!studentName || !quizCode) {
            studentName = 'Demo Student';
            quizCode = 'DEMO123';
            sessionStorage.setItem('studentName', studentName);
            sessionStorage.setItem('quizCode', quizCode);
            sessionStorage.setItem('studentEmail', 'demo@example.com');
            sessionStorage.setItem('authToken', 'demo-authorized');
            sessionStorage.setItem('demoMode', 'true');
        }

        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizStartTime = new Date();
        let timerInterval = null;
        let elapsedSeconds = 0;

        document.addEventListener('DOMContentLoaded', function() {
            loadQuiz();
        });

        async function loadQuiz() {
            try {
                const codeParam = quizCode ? `?code=${encodeURIComponent(quizCode)}` : '';
                const response = await fetch(`/api/quiz${codeParam}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': sessionStorage.getItem('authToken') || '',
                        'X-Quiz-Code': quizCode
                    }
                });
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data && data.questions && data.questions.length > 0) {
                            currentQuiz = data;
                            initializeQuiz();
                            return;
                        }
                    }
                }
                throw new Error('Server response invalid');
            } catch (error) {
                console.log('Server unavailable, loading demo quiz:', error.message);
                loadDemoQuiz();
            }
        }

        function loadDemoQuiz() {
            currentQuiz = {
                title: 'Sample Commerce Quiz (Demo)',
                timeLimit: 10,
                questions: [
                    {
                        id: 1,
                        question: 'What is the primary purpose of marketing?',
                        options: [
                            'To increase production costs',
                            'To satisfy customer needs and wants',
                            'To reduce competition',
                            'To eliminate profit margins'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 2,
                        question: 'Which of the following is NOT a factor of production?',
                        options: ['Land', 'Labor', 'Capital', 'Profit'],
                        correct_answer: 3
                    },
                    {
                        id: 3,
                        question: 'What does GDP stand for?',
                        options: [
                            'General Development Plan',
                            'Gross Domestic Product',
                            'Government Debt Program',
                            'Global Distribution Policy'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 4,
                        question: 'What is supply and demand?',
                        options: [
                            'A government regulation',
                            'An economic principle that determines prices',
                            'A type of business loan',
                            'A marketing strategy'
                        ],
                        correct_answer: 1
                    },
                    {
                        id: 5,
                        question: 'What does ROI stand for?',
                        options: [
                            'Return on Investment',
                            'Rate of Interest',
                            'Risk of Inflation',
                            'Revenue of Income'
                        ],
                        correct_answer: 0
                    }
                ]
            };
            initializeQuiz();
        }

        function initializeQuiz() {
            document.getElementById('quiz-title span').textContent = currentQuiz.title || 'Quiz';
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('quiz-content').style.display = 'block';
            quizStartTime = new Date();
            startTimer();
            loadQuestion(0);
        }

        function loadQuestion(index) {
            const questions = currentQuiz.questions;
            const total = questions.length;
            if (!questions || total === 0) return;

            currentQuestionIndex = index;
            const question = questions[index];

            const pct = ((index) / total) * 100;
            document.getElementById('progress-fill').style.width = pct + '%';
            document.getElementById('question-counter').textContent = `Question ${index + 1} of ${total}`;

            const qText = question.question || question.question_text || '';
            document.getElementById('question-text').textContent = qText;

            let opts;
            if (question.options && Array.isArray(question.options)) {
                opts = question.options;
            } else {
                opts = [question.option_a, question.option_b, question.option_c, question.option_d];
            }

            const letters = ['A', 'B', 'C', 'D'];
            const container = document.getElementById('options');
            container.innerHTML = '';

            opts.forEach((optText, i) => {
                const el = document.createElement('div');
                el.className = 'option-card';
                if (userAnswers[question.id] === i) el.classList.add('selected');
                el.onclick = () => selectOption(i, el, question.id);
                el.innerHTML = `
                    <div class="option-label">${letters[i]}</div>
                    <div class="option-text">${optText}</div>
                `;
                container.appendChild(el);
            });

            document.getElementById('prev-btn').disabled = index === 0;
            const nextBtn = document.getElementById('next-btn');
            if (index === total - 1) {
                nextBtn.innerHTML = `
                    Submit
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                `;
            } else {
                nextBtn.innerHTML = `
                    Next
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                `;
            }
        }

        function selectOption(index, element, questionId) {
            document.querySelectorAll('.option-card').forEach(o => o.classList.remove('selected'));
            element.classList.add('selected');
            userAnswers[questionId] = index;
        }

        function nextQuestion() {
            const total = currentQuiz.questions.length;
            if (currentQuestionIndex < total - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            elapsedSeconds = 0;
            const timeLimit = currentQuiz.timeLimit ? currentQuiz.timeLimit * 60 : null;
            
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                if (timeLimit) {
                    const remaining = timeLimit - elapsedSeconds;
                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        finishQuiz();
                        return;
                    }
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    timerEl.querySelector('span').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    timerEl.className = 'timer' + (remaining < 30 ? ' red' : remaining < 60 ? ' amber' : '');
                } else {
                    const m = Math.floor(elapsedSeconds / 60);
                    const s = elapsedSeconds % 60;
                    timerEl.querySelector('span').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                }
            }, 1000);
        }

        function finishQuiz() {
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('progress-fill').style.width = '100%';

            const questions = currentQuiz.questions;
            let correct = 0;

            questions.forEach(q => {
                const userAns = userAnswers[q.id];
                const correctAns = q.correct_answer;
                let correctIdx = typeof correctAns === 'number' ? correctAns :
                    (typeof correctAns === 'string' ? 'ABCD'.indexOf(correctAns.toUpperCase()) : null);
                if (userAns !== undefined && userAns !== null && correctIdx !== null && userAns === correctIdx) {
                    correct++;
                }
            });

            const total = questions.length;
            const pct = total > 0 ? Math.round((correct / total) * 100) : 0;

            submitResults(correct, total, pct);
            showResults(correct, total, pct);
        }

        async function submitResults(correct, total, percentage) {
            const questions = currentQuiz.questions;
            const answersArray = questions.map(q => {
                const ans = userAnswers[q.id];
                return (ans !== undefined && ans !== null) ? ans : null;
            });

            try {
                await fetch('/api/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': sessionStorage.getItem('authToken') || ''
                    },
                    body: JSON.stringify({
                        email: sessionStorage.getItem('studentEmail'),
                        name: studentName,
                        code: quizCode,
                        answers: answersArray,
                        quizStartTime: quizStartTime.toISOString(),
                        quizDurationSeconds: elapsedSeconds
                    })
                });
            } catch (error) {
                console.log('Could not submit results to server:', error.message);
            }
        }

        function showResults(correct, total, pct) {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('top-bar').style.display = 'none';
            const resultsEl = document.getElementById('results-screen');
            resultsEl.style.display = 'block';

            const circumference = 440;
            const ring = document.getElementById('score-ring-fill');
            const gradeClass = pct >= 80 ? 'excellent' : pct < 50 ? 'poor' : pct < 65 ? 'average' : 'good';
            ring.className = 'score-ring-fill ' + gradeClass;
            const offset = circumference - (pct / 100) * circumference;
            setTimeout(() => { ring.style.strokeDashoffset = offset; }, 50);

            const emojis = { excellent: 'üéâ', good: 'üëç', average: 'üìö', poor: 'üìñ' };
            document.getElementById('score-emoji').textContent = emojis[gradeClass];

            const scorePctEl = document.getElementById('score-pct');
            scorePctEl.className = 'score-pct ' + gradeClass;
            scorePctEl.textContent = pct + '%';
            document.getElementById('score-fraction').textContent = `${correct}/${total}`;

            let feedback, pillText;
            if (pct >= 90) { feedback = 'üéâ Excellent work!'; pillText = 'Outstanding performance'; }
            else if (pct >= 75) { feedback = 'üëç Great job!'; pillText = 'You did really well'; }
            else if (pct >= 60) { feedback = 'üìö Good effort!'; pillText = 'Keep practicing to improve'; }
            else if (pct >= 50) { feedback = 'üòê You passed!'; pillText = 'Review the material'; }
            else { feedback = 'üìñ Keep studying!'; pillText = "Don't give up ‚Äî review and retry"; }
            document.getElementById('score-feedback').textContent = feedback;
            document.getElementById('score-pill-wrap').innerHTML =
                `<span class="score-pill ${gradeClass}">${pillText}</span>`;

            const breakdownList = document.getElementById('breakdown-list');
            breakdownList.innerHTML = '';
            const letters = ['A', 'B', 'C', 'D'];
            const questions = currentQuiz.questions;

            questions.forEach((q, idx) => {
                const qText = q.question || q.question_text || '';
                let opts = (q.options && Array.isArray(q.options)) ? q.options :
                    [q.option_a, q.option_b, q.option_c, q.option_d];
                const userAns = userAnswers[q.id];
                const correctAns = q.correct_answer;
                let correctIdx = typeof correctAns === 'number' ? correctAns :
                    (typeof correctAns === 'string' ? 'ABCD'.indexOf(correctAns.toUpperCase()) : null);

                const isCorrect = userAns === correctIdx;
                const isSkipped = userAns === undefined || userAns === null;

                const item = document.createElement('div');
                item.className = `breakdown-item ${isSkipped ? '' : (isCorrect ? 'correct' : 'incorrect')}`;
                
                let answersHtml = '';
                opts.forEach((opt, i) => {
                    const isThisCorrect = i === correctIdx;
                    const isThisSelected = i === userAns;
                    
                    let icon = '';
                    let className = 'breakdown-answer';
                    
                    if (isThisCorrect) {
                        icon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
                        className += ' correct';
                    } else if (isThisSelected && !isThisCorrect) {
                        icon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
                        className += ' incorrect';
                    }
                    
                    answersHtml += `
                        <div class="${className}">
                            <div class="breakdown-answer-icon">${icon}</div>
                            <span class="breakdown-answer-text ${isThisSelected ? 'selected' : ''}">${opt}</span>
                        </div>
                    `;
                });

                item.innerHTML = `
                    <div class="breakdown-q">${idx + 1}. ${qText}</div>
                    <div class="breakdown-answers">${answersHtml}</div>
                `;
                breakdownList.appendChild(item);
            });
        }
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
