<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }

        /* Additional smooth scrolling for all elements */
        * {
            scroll-behavior: smooth;
        }

        /* Smooth transitions for form changes */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }

        body {
            font-family: 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        h1, h2, h3, h4, h5, h6, .font-playfair {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }
        .btn {
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.2s ease-in-out, box-shadow 0.1s ease-out, transform 0.1s ease-out;
            border-radius: 0.5rem;
            padding: 0.875rem 1.5rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            letter-spacing: 0.025em;
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn:active:not(:disabled) { transform: scale(0.98); box-shadow: inset 0 1px 2px rgba(0,0,0,0.07); }
        .input-field {
            font-family: 'Roboto', sans-serif;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.875rem 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); padding: 2rem; }
        .option-label input[type="radio"]:focus-visible + .option-content { outline: 2px solid #3b82f6; outline-offset: 2px; border-radius: 0.375rem; }
        .option-label input[type="radio"]:checked + .option-content { font-weight: 500; color: #1e40af; }
        .option-label.selected .option-content { background-color: #eff6ff; border-color: #60a5fa; }
        .option-content { font-family: 'Roboto', sans-serif; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out; }
        .option-label:hover .option-content { background-color: #f9fafb; border-color: #9ca3af; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 3px;}
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px;}
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        @keyframes modal-pop-in { 0% { transform: translateY(20px) scale(0.98); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
        .animate-modal-pop-in { animation: modal-pop-in 0.25s ease-out forwards; }
        .auth-toggle-link { font-family: 'Roboto', sans-serif; color: #3b82f6; font-weight: 500; cursor: pointer; }
        .auth-toggle-link:hover { text-decoration: underline; color: #2563eb; }
        #progress-bar-fill { transition: width 0.3s ease-in-out; }
        .text-3xl.font-extrabold, .text-2xl.font-bold, .text-3xl.font-bold, .text-xl.font-semibold { font-family: 'Playfair Display', serif; }
        #result-section h2.font-bold { font-family: 'Playfair Display', serif; font-weight: 700; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 selection:bg-blue-500 selection:text-white">

    <div class="container w-full max-w-xl mx-auto">

        <div id="login-section" class="card space-y-6">
            <div class="text-center mb-6">
                <svg class="w-16 h-16 mx-auto text-blue-600 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                <h1 class="text-3xl font-extrabold text-slate-900">QuizFlow Login</h1>
                <p class="text-slate-500 mt-1.5 text-base">Please sign in to begin.</p>
            </div>
            <div>
                <label for="login-name" class="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wider">Full Name (If Registering)</label>
                <input type="text" id="login-name" placeholder="Enter your full name" class="input-field">
            </div>
            <div>
                <label for="login-email" class="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wider">Email Address</label>
                <input type="email" id="login-email" placeholder="Enter your email" class="input-field">
            </div>
            <div>
                <label for="login-password" class="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wider">Password</label>
                <input type="password" id="login-password" placeholder="Enter your password" class="input-field">
            </div>
            <button onclick="login()" id="login-button" class="w-full btn btn-primary">Login & Start Quiz</button>
            <button id="view-past-submissions-btn" style="display:none;" onclick="showPastSubmissionsView()" class="w-full btn btn-secondary mt-3">
                View My Past Quizzes
            </button>
            <p class="text-center text-sm text-slate-600 mt-4">
                Don't have an account? <span onclick="toggleAuthView('register')" class="auth-toggle-link">Register here</span>
            </p>
        </div>

        <div id="register-section" style="display: none;" class="card space-y-6">
            <div class="text-center mb-6">
                 <svg class="w-16 h-16 mx-auto text-blue-600 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
                <h1 class="text-3xl font-extrabold text-slate-900">Create Account</h1>
                <p class="text-slate-500 mt-1.5 text-base">Join QuizFlow today!</p>
            </div>
            <div>
                <label for="register-name" class="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wider">Full Name</label>
                <input type="text" id="register-name" placeholder="Enter your full name" class="input-field">
            </div>
            <div>
                <label for="register-email" class="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wider">Email Address</label>
                <input type="email" id="register-email" placeholder="Enter your email" class="input-field">
            </div>
            <div>
                <label for="register-password" class="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wider">Password</label>
                <input type="password" id="register-password" placeholder="Choose a password (min. 6 characters)" class="input-field">
            </div>
            <div>
                <label for="register-confirm-password" class="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wider">Confirm Password</label>
                <input type="password" id="register-confirm-password" placeholder="Confirm your password" class="input-field">
            </div>
            <button onclick="register()" id="register-button" class="w-full btn btn-primary">Register</button>
            <p class="text-center text-sm text-slate-600">Already have an account? <span onclick="toggleAuthView('login')" class="auth-toggle-link">Login here</span></p>
        </div>

        <div id="quiz-section" style="display: none;" class="card">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 pb-4 border-b border-slate-200">
                <h2 id="quiz-title" class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2 sm:mb-0">Quiz Time!</h2>
                <div class="flex items-center space-x-2 sm:space-x-4 mt-2 sm:mt-0">
                    <div id="timer" class="text-lg sm:text-xl font-semibold text-red-600 bg-red-100 px-3 py-1 sm:px-4 sm:py-1.5 rounded-md font-roboto">00:00</div>
                    <div id="progress-bar-container" class="w-28 sm:w-40">
                        <div class="text-xs text-slate-500 mb-0.5 text-right font-roboto">Progress: <span id="progress-text">0%</span></div>
                        <div class="w-full bg-slate-200 rounded-full h-2 sm:h-2.5"><div id="progress-bar-fill" class="bg-blue-600 h-2 sm:h-2.5 rounded-full" style="width: 0%;"></div></div>
                    </div>
                </div>
            </div>
            <div class="mb-5 p-3 bg-yellow-50 border border-yellow-300 text-yellow-700 rounded-md text-sm">
                <div class="flex items-center"><svg class="h-5 w-5 text-yellow-500 mr-2 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg><p>Stay focused. Navigating away may end the quiz.</p></div>
            </div>
            <div id="question-container" class="space-y-8"></div>
            <button onclick="submitQuizConfirm()" id="submit-quiz-button" class="w-full mt-10 btn btn-primary bg-green-600 hover:bg-green-700" style="display: none;">Submit Quiz</button>
        </div>

        <div id="result-section" style="display: none;" class="card text-center space-y-6">
            <h2 id="result-section-title" class="text-3xl font-bold text-slate-900">Quiz Result</h2>
            <div id="result-details" class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                <p id="user-email-result" class="text-xl font-playfair font-semibold text-slate-700 mb-3"></p>
                <p id="result-score" class="text-4xl font-playfair font-extrabold text-blue-600 mb-1"></p>
                <p id="result-percentage" class="text-lg text-slate-500 mb-4"></p>
                <div id="feedback-message" class="text-base font-medium p-3 rounded-md"></div>
            </div>
            <div id="detailed-quiz-results" class="mt-6 text-left"></div>
            <div class="flex flex-col sm:flex-row justify-center sm:space-x-3 space-y-3 sm:space-y-0 mt-6">
                <button onclick="printResults()" id="print-results-button" class="w-full sm:w-auto btn btn-secondary">Print Results</button>
                <button onclick="logoutAndRestart()" class="w-full sm:w-auto btn btn-primary">Logout</button>
            </div>
        </div>

        <div id="past-submissions-section" style="display: none;" class="card space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl sm:text-3xl font-bold text-slate-900">My Past Quizzes</h2>
                <button onclick="showMainLoginOrQuizView()" class="btn btn-secondary text-sm py-2 px-3">Back to Main</button>
            </div>
            <div id="submissions-list-container" class="space-y-4">
                <p id="loading-submissions-message" class="text-slate-600">Loading your submissions...</p>
            </div>
        </div>

        <div id="submission-detail-section" style="display: none;" class="card space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="submission-detail-quiz-title" class="text-2xl sm:text-3xl font-bold text-slate-900">Detailed Quiz Result</h2>
                 <button onclick="showPastSubmissionsView(true)" class="btn btn-secondary text-sm py-2 px-3">Back to List</button>
            </div>
            <div id="submission-detail-summary" class="bg-slate-50 p-4 sm:p-6 rounded-lg border border-slate-200 mb-6 text-sm sm:text-base"></div>
            <h3 class="text-xl sm:text-2xl font-semibold text-slate-800 mt-6 mb-3">Question Breakdown:</h3>
            <div id="submission-detail-questions" class="space-y-4"></div>
        </div>

        <div id="message-modal" style="display: none;" class="fixed inset-0 bg-slate-800 bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
            <div class="bg-white p-7 rounded-lg shadow-xl max-w-md w-full mx-auto transform transition-all duration-300 ease-out scale-95 opacity-0 animate-modal-pop-in">
                <h3 id="modal-title-element" class="text-xl font-playfair font-semibold mb-4 text-slate-800">Notification</h3>
                <div id="modal-message-element" class="text-slate-600 mb-6 text-sm leading-relaxed"></div>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-button" style="display:none;" onclick="closeModal()" class="btn btn-secondary text-sm py-2 px-4">Cancel</button>
                    <button id="modal-ok-button" onclick="closeModal()" class="btn btn-primary text-sm py-2 px-4">OK</button>
                    <button id="modal-confirm-button" style="display:none;" class="btn btn-primary bg-red-600 hover:bg-red-700 text-sm py-2 px-4">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let quizDataStore = [];
        let quizTimeLimit = 1200; // Default, will be updated from API, but not actively used for global timer
        let timePerQuestion = 30; // NEW: Default, will be updated from API
        let quizTimerInterval; // For global timer (now likely unused)
        let currentUserEmailGlobal = "";
        let currentUserIdGlobal = null; // To store user ID from login
        let quizActive = false;
        let userFocusLossCount = 0;
        const MAX_USER_FOCUS_LOSS = 2;
        window.latestQuizResultForPrinting = null;
        let answeredQuestionsCount = 0;

        let currentQuestionIndex = 0; // NEW: Tracks current question for per-question flow
        let perQuestionAnswers = []; // NEW: Stores answers for per-question flow
        let perQuestionTimer = null; // NEW: Timer for current question

        // DOM Elements
        const loginSection = document.getElementById("login-section");
        const registerSection = document.getElementById("register-section");
        const quizSection = document.getElementById("quiz-section");
        const resultSection = document.getElementById("result-section");
        const pastSubmissionsSection = document.getElementById("past-submissions-section");
        const submissionDetailSection = document.getElementById("submission-detail-section");

        const questionContainer = document.getElementById("question-container");
        const timerDisplay = document.getElementById("timer");
        const progressBarFill = document.getElementById("progress-bar-fill");
        const progressText = document.getElementById("progress-text");

        const loginNameInput = document.getElementById("login-name"); // Used for registration toggle convenience
        const loginNameLabel = document.querySelector('label[for="login-name"]'); // Get the label too
        const loginEmailInput = document.getElementById("login-email");
        const loginPasswordInput = document.getElementById("login-password");
        const loginButton = document.getElementById("login-button");
        const viewPastSubmissionsBtn = document.getElementById("view-past-submissions-btn");
        // Removed quizDifficultySelector as the element is removed from HTML

        const registerNameInput = document.getElementById("register-name");
        const registerEmailInput = document.getElementById("register-email");
        const registerPasswordInput = document.getElementById("register-password");
        const registerConfirmPasswordInput = document.getElementById("register-confirm-password");
        const registerButton = document.getElementById("register-button");

        const resultScoreDisplay = document.getElementById("result-score");
        const resultPercentageDisplay = document.getElementById("result-percentage");
        const userEmailResultDisplay = document.getElementById("user-email-result");
        const feedbackMessageDisplay = document.getElementById("feedback-message");
        const quizTitleDisplay = document.getElementById("quiz-title"); // For quiz section title
        const resultSectionTitle = document.getElementById("result-section-title"); // For result section title
        const submitQuizButton = document.getElementById("submit-quiz-button"); // Now used for final auto-submit

        const messageModal = document.getElementById("message-modal");
        const modalTitleElement = document.getElementById("modal-title-element");
        const modalMessageElement = document.getElementById("modal-message-element");
        const modalOkButton = document.getElementById("modal-ok-button");
        const modalConfirmButton = document.getElementById("modal-confirm-button");
        const modalCancelButton = document.getElementById("modal-cancel-button");

        document.addEventListener('DOMContentLoaded', () => {
            toggleAuthView('login'); // Start with the login view
        });

        function hideAllSections() {
            loginSection.style.display = "none";
            registerSection.style.display = "none";
            quizSection.style.display = "none";
            resultSection.style.display = "none";
            pastSubmissionsSection.style.display = "none";
            submissionDetailSection.style.display = "none";
            if (!currentUserEmailGlobal && viewPastSubmissionsBtn) {
                viewPastSubmissionsBtn.style.display = 'none';
            }
        }

        function toggleAuthView(view) {
            hideAllSections();
            if (view === 'register') {
                registerSection.style.display = "block";
                // If loginNameInput and its label exist, hide them or manage their relevance
                if(loginNameInput) loginNameInput.style.display = 'none';
                if(loginNameLabel) loginNameLabel.style.display = 'none';

                // Pre-fill name for registration if user typed it in the login form's name field
                if(loginNameInput && registerNameInput) registerNameInput.value = loginNameInput.value;
                registerEmailInput.value = loginEmailInput.value; // Pre-fill email
                registerNameInput.focus();
            } else { // 'login' view
                loginSection.style.display = "block";
                if(loginNameInput) loginNameInput.style.display = 'block'; // This field is now primarily for register convenience
                if(loginNameLabel) loginNameLabel.style.display = 'block';
                loginEmailInput.focus();
            }
            if (viewPastSubmissionsBtn) {
                 viewPastSubmissionsBtn.style.display = currentUserEmailGlobal ? 'block' : 'none';
            }
        }

        function showModal(title, message, type = "alert", onConfirm = null, onCancel = null) {
            modalTitleElement.textContent = title;
            modalMessageElement.innerHTML = message;
            messageModal.style.display = "flex";
            const modalContent = messageModal.firstElementChild;
            modalContent.classList.remove('animate-modal-pop-in');
            void modalContent.offsetWidth; // Trigger reflow to restart animation
            modalContent.classList.add('animate-modal-pop-in');
            modalOkButton.style.display = (type === "alert") ? "inline-block" : "none";
            modalConfirmButton.style.display = (type === "confirm") ? "inline-block" : "none";
            modalCancelButton.style.display = (type === "confirm") ? "inline-block" : "none";
            if (type === "confirm") {
                modalConfirmButton.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
                modalCancelButton.onclick = () => { closeModal(); if (onCancel) onCancel(); };
                modalConfirmButton.focus();
            } else {
                modalOkButton.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
                modalOkButton.focus();
            }
        }
        function closeModal() { messageModal.style.display = "none"; }

        // --- Anti-Cheating Listeners (Keep as is) ---
        function handleVisibilityChange() {
            if (!quizActive || !document.hidden) return;
            userFocusLossCount++;
            let msg = `Warning ${userFocusLossCount}/${MAX_USER_FOCUS_LOSS}: You've navigated away from the quiz. <br>Please remain on this tab to avoid quiz termination.`;
            if (userFocusLossCount >= MAX_USER_FOCUS_LOSS) {
                msg += "<br>The quiz will be submitted automatically if you navigate away again or after this warning.";
                showModal("Final Warning!", msg, "alert", () => {
                    // This callback fires after OK is clicked.
                    // If user navigated away AGAIN after this, then submit.
                    if (userFocusLossCount > MAX_USER_FOCUS_LOSS && quizActive) submitQuizSingle();
                });
                // If user navigates away multiple times without clicking OK, also auto-submit
                if (userFocusLossCount > MAX_USER_FOCUS_LOSS && quizActive) submitQuizSingle();
            } else {
                showModal("Warning!", msg);
            }
        }
        function setupAntiCheatingListeners() { document.addEventListener("visibilitychange", handleVisibilityChange); }
        function removeAntiCheatingListeners() { document.removeEventListener("visibilitychange", handleVisibilityChange); }

        // --- Auth Functions ---
        async function register() {
            const name = registerNameInput.value.trim();
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value;
            const confirmPassword = registerConfirmPasswordInput.value;

            if (!name || !email || !password || !confirmPassword) {
                showModal("Input Required", "Please fill in all registration fields (Name, Email, Password, Confirm Password).");
                return;
            }
            if (!/\S+@\S+\.\S+/.test(email)) {
                showModal("Invalid Email", "Please enter a valid email address.");
                return;
            }
            if (password.length < 6) {
                showModal("Password Too Short", "Password must be at least 6 characters long.");
                return;
            }
            if (password !== confirmPassword) {
                showModal("Password Mismatch", "Passwords do not match. Please re-enter.");
                registerConfirmPasswordInput.value = "";
                registerConfirmPasswordInput.focus();
                return;
            }

            registerButton.disabled = true;
            registerButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Registering...`;

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password }) // name IS included
                });
                const result = await response.json();
                if (result.success) {
                    showModal("Registration Successful!", result.message || "You can now log in.", "alert", () => {
                        toggleAuthView('login');
                        loginEmailInput.value = email;
                        loginNameInput.value = name; // Pre-fill name on login form too
                        loginPasswordInput.value = "";
                        registerNameInput.value = ""; registerEmailInput.value = "";
                        registerPasswordInput.value = ""; registerConfirmPasswordInput.value = "";
                        loginPasswordInput.focus();
                    });
                } else {
                    showModal("Registration Failed", result.message || "Could not register. Email might already be in use.");
                }
            } catch (error) {
                console.error("Registration API error:", error);
                showModal("Registration Error", "Service unavailable. Please try again later.");
            } finally {
                registerButton.disabled = false;
                registerButton.textContent = "Register";
            }
        }

        async function login() {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            // Removed selectedDifficulty variable as the element is removed.

            if (!email || !password) {
                showModal("Input Required", "Please enter both email and password.");
                return;
            }
            loginButton.disabled = true;
            loginButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Authenticating...`;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }) // Only email and password for login
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    currentUserEmailGlobal = result.email;
                    currentUserIdGlobal = result.user_id;
                    if (viewPastSubmissionsBtn) viewPastSubmissionsBtn.style.display = 'block';

                    // If user has already taken THIS specific quiz, show past results.
                    if (result.quiz_already_taken && result.past_results) {
                        hideAllSections();
                        resultSection.style.display = "block";
                        const past = result.past_results;
                        window.latestQuizResultForPrinting = { email: currentUserEmailGlobal, score: past.score, totalQuestions: past.totalQuestions, percentage: past.percentage, feedback: past.feedback, title: past.quizTitle || "Quiz Results", detailed_results: [] };
                        resultSectionTitle.textContent = past.quizTitle || "Previous Quiz Results";
                        displayResults(past.score, past.totalQuestions, past.percentage, past.feedback, []);
                        userEmailResultDisplay.textContent = `Welcome back, ${currentUserEmailGlobal.split('@')[0]}! Results for "${past.quizTitle || 'the quiz'}":`;
                        showModal("Previous Results Loaded", result.message || "Displayed your previous results for this quiz.");
                    } else {
                        hideAllSections(); // Ensure only quiz section is shown
                        // Call startQuizFlow without a difficulty parameter
                        await startQuizFlow(); // No difficulty parameter passed now
                    }
                } else {
                    showModal("Login Failed", result.message || "Invalid email or password.");
                    loginPasswordInput.value = "";
                    loginPasswordInput.focus(); // Keep focus on password for re-entry
                }
            } catch (error) {
                console.error("Login API error:", error);
                showModal("Login Error", "Service unavailable. Please try again later.");
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = "Login & Start Quiz";
            }
        }

        // --- Quiz Flow Functions ---
        // startQuizFlow no longer accepts a difficulty parameter
        async function startQuizFlow() { // Removed difficulty parameter
            hideAllSections();
            quizSection.style.display = "block";
            resultSection.style.display = "none";
            submitQuizButton.style.display = "none"; // Hide general submit button as we use per-question
            quizActive = true;
            userFocusLossCount = 0;
            currentQuestionIndex = 0;
            perQuestionAnswers = [];
            // fetchQuizData now called without difficulty parameter
            await fetchQuizData(); // Removed difficulty parameter
            if (quizDataStore.length > 0) {
                updateProgressSingle();
                showSingleQuestion(currentQuestionIndex);
                setupAntiCheatingListeners();
            } else {
                showModal("Error Loading Quiz", "Could not load quiz data. Please try logging out and back in, or contact support.");
                quizActive = false;
                removeAntiCheatingListeners();
                showMainLoginOrQuizView();
            }
        }

        // fetchQuizData no longer accepts a difficulty parameter
        async function fetchQuizData() { // Removed difficulty parameter
            try {
                const response = await fetch(`/api/quiz`); // Removed difficulty query parameter
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({ message: "Failed to parse error from server."}));
                    throw new Error(errData.message || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if(data.success){
                    quizDataStore = data.questions || [];
                    quizTitleDisplay.textContent = data.title || "Quiz Challenge";
                    timePerQuestion = data.timePerQuestion || 30; // Get timePerQuestion from backend
                    console.log(`Quiz loaded: ${data.title}, Time per question: ${timePerQuestion}s`);
                } else {
                    throw new Error(data.message || "Backend reported failure in fetching quiz data.");
                }
            } catch (error) {
                console.error("Fetch quiz data error:", error);
                showModal("Fetch Error", `Could not retrieve quiz questions: ${error.message}`);
                quizDataStore = []; // Ensure it's empty on error
            }
        }

        // --- Per-Question Quiz Logic ---
        function showSingleQuestion(index) {
            if (!quizDataStore || quizDataStore.length === 0 || index >= quizDataStore.length) {
                submitQuizSingle(); // Ensure quiz is submitted if somehow called past last question
                return;
            }

            questionContainer.innerHTML = ""; // Clear previous question
            const q = quizDataStore[index];
            const qDiv = document.createElement("div");
            qDiv.className = "question bg-white border border-slate-200 p-6 rounded-lg";
            const optionsHTML = Array.isArray(q.options) ?
                q.options.map((opt, j) =>
                    `<label class="option-label flex items-center cursor-pointer group ${perQuestionAnswers[index] === j ? 'selected' : ''}" data-question-index="${index}" data-option-index="${j}">
                        <input type="radio" name="q${index}" value="${j}" class="form-radio h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-400 shrink-0" ${perQuestionAnswers[index] === j ? 'checked' : ''}>
                        <span class="option-content ml-3 text-slate-700 text-sm group-hover:border-slate-400 flex-grow">${opt}</span>
                     </label>`
                ).join("") :
                "<p>Error: Options not available for this question.</p>";
            qDiv.innerHTML = `<p class="text-base font-medium text-slate-800 mb-4">${index + 1}. ${q.question}</p><div class="space-y-3">${optionsHTML}</div>`;
            questionContainer.appendChild(qDiv);

            // Option select handler
            questionContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    // Update UI for selected option
                    document.querySelectorAll(`input[name="q${index}"]`).forEach(r => r.closest('.option-label').classList.remove('selected'));
                    if (event.target.checked) event.target.closest('.option-label').classList.add('selected');

                    perQuestionAnswers[index] = parseInt(event.target.value, 10);
                    clearInterval(perQuestionTimer); // Stop timer on selection
                    nextSingleQuestion(); // Move to next question immediately
                });
            });

            startPerQuestionTimer(); // Start timer for this question
            updateProgressSingle(); // Update progress bar
        }

        function startPerQuestionTimer() {
            let timeLeft = timePerQuestion; // Use timePerQuestion from backend
            timerDisplay.textContent = formatTime(timeLeft);
            clearInterval(perQuestionTimer); // Clear any existing timer
            perQuestionTimer = setInterval(() => {
                if (!quizActive) { // Ensure quiz is still active
                    clearInterval(perQuestionTimer);
                    return;
                }
                timeLeft--;
                timerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(perQuestionTimer);
                    // Save as unanswered if not answered for the current question
                    if (perQuestionAnswers[currentQuestionIndex] === undefined || perQuestionAnswers[currentQuestionIndex] === null) {
                        perQuestionAnswers[currentQuestionIndex] = null;
                    }
                    nextSingleQuestion(); // Auto-advance to next question
                }
            }, 1000);
        }

        function nextSingleQuestion() {
            clearInterval(perQuestionTimer); // Ensure timer is stopped
            currentQuestionIndex++; // Move to the next question index
            if (currentQuestionIndex < quizDataStore.length) {
                showSingleQuestion(currentQuestionIndex); // Show the next question
            } else {
                // All questions done, submit the quiz
                submitQuizSingle();
            }
        }

        function updateProgressSingle() {
            const percent = quizDataStore.length > 0 ? Math.round(((currentQuestionIndex) / quizDataStore.length) * 100) : 0;
            progressBarFill.style.width = `${percent}%`;
            progressText.textContent = `${percent}%`;
        }

        async function submitQuizSingle() { // Renamed from submitQuiz to reflect per-question flow
            quizActive = false;
            removeAntiCheatingListeners();
            clearInterval(perQuestionTimer);
            submitQuizButton.disabled = true;
            submitQuizButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Submitting...`;

            if (!currentUserEmailGlobal) {
                showModal("Error", "User not logged in. Cannot submit quiz.");
                submitQuizButton.disabled = false;
                submitQuizButton.textContent = "Submit Quiz"; // Restore button text
                return;
            }

            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentUserEmailGlobal,
                        answers: perQuestionAnswers // Send the collected per-question answers
                    })
                });
                const result = await response.json();

                if (result.success) {
                    hideAllSections();
                    resultSection.style.display = "block";
                    resultSectionTitle.textContent = quizTitleDisplay.textContent + " - Results";
                    window.latestQuizResultForPrinting = {
                        email: currentUserEmailGlobal,
                        score: result.score,
                        totalQuestions: result.totalQuestions,
                        percentage: result.percentage,
                        feedback: result.feedback,
                        title: quizTitleDisplay.textContent,
                        detailed_results: result.detailed_results
                    };
                    displayResults(result.score, result.totalQuestions, result.percentage, result.feedback, result.detailed_results);
                } else {
                    showModal("Submission Failed", result.message || "An error occurred while submitting.");
                    submitQuizButton.disabled = false;
                    submitQuizButton.textContent = "Submit Quiz";
                    quizActive = true;
                    setupAntiCheatingListeners();
                }
            } catch (error) {
                console.error("Submission API error:", error);
                showModal("Submission Error", "A network error occurred. Please check your connection and try again.");
                submitQuizButton.disabled = false;
                submitQuizButton.textContent = "Submit Quiz";
                quizActive = true;
                setupAntiCheatingListeners();
            }
        }

        // Common Utility Functions (keep as is or adapt if needed)
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function displayResults(score, totalQuestions, percentage, feedback, detailedResults) {
            resultScoreDisplay.textContent = `Score: ${score}/${totalQuestions}`;
            resultPercentageDisplay.textContent = `${percentage.toFixed(2)}%`;
            feedbackMessageDisplay.textContent = feedback;
            feedbackMessageDisplay.className = `text-base font-medium p-3 rounded-md mt-4 ${percentage >= 60 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            userEmailResultDisplay.textContent = `Email: ${currentUserEmailGlobal}`;

            const detailedResultsContainer = document.getElementById("detailed-quiz-results");
            detailedResultsContainer.innerHTML = "";
            detailedResults.forEach(item => {
                const qDiv = document.createElement("div");
                qDiv.className = `p-4 mb-3 rounded-lg border ${item.is_correct ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                qDiv.innerHTML = `
                    <p class="font-semibold">${item.question_text}</p>
                    <p class="text-sm mt-1">Your Answer: <span class="${item.is_correct ? 'text-green-700' : 'text-red-700'} font-medium">${item.user_selected_answer_text}</span></p>
                    <p class="text-sm">Correct Answer: <span class="text-green-700 font-medium">${item.correct_answer_text}</span></p>
                `;
                detailedResultsContainer.appendChild(qDiv);
            });
        }

        async function showPastSubmissionsView(backToList = false) {
            hideAllSections();
            pastSubmissionsSection.style.display = "block";
            const submissionsListContainer = document.getElementById("submissions-list-container");
            const loadingMessage = document.getElementById("loading-submissions-message");
            submissionsListContainer.innerHTML = ''; // Clear previous list
            loadingMessage.style.display = 'block';

            if (!currentUserEmailGlobal) {
                showModal("Error", "Please log in to view past submissions.");
                loadingMessage.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/user/submissions?email=${currentUserEmailGlobal}`);
                const result = await response.json();

                loadingMessage.style.display = 'none'; // Hide loading message once data is fetched

                if (result.success && result.submissions.length > 0) {
                    result.submissions.forEach(sub => {
                        const subDiv = document.createElement("div");
                        subDiv.className = "card p-4 mb-3 cursor-pointer hover:bg-slate-50 transition-colors";
                        subDiv.innerHTML = `
                            <p class="text-lg font-playfair font-semibold">${sub.quiz_title}</p>
                            <p class="text-sm text-slate-600">Score: ${sub.score}/${sub.total_questions_in_quiz} (${sub.percentage.toFixed(2)}%)</p>
                            <p class="text-xs text-slate-500">Submitted: ${new Date(sub.submitted_at).toLocaleString()}</p>
                        `;
                        subDiv.onclick = () => showSubmissionDetails(sub.submission_id);
                        submissionsListContainer.appendChild(subDiv);
                    });
                } else {
                    submissionsListContainer.innerHTML = '<p class="text-slate-600 text-center py-4">No past submissions found.</p>';
                }
            } catch (error) {
                console.error("Error fetching past submissions:", error);
                submissionsListContainer.innerHTML = '<p class="text-red-500 text-center py-4">Failed to load submissions. Please try again.</p>';
            }
        }

        async function showSubmissionDetails(submissionId) {
            hideAllSections();
            submissionDetailSection.style.display = "block";
            const submissionDetailSummary = document.getElementById("submission-detail-summary");
            const submissionDetailQuestions = document.getElementById("submission-detail-questions");
            const submissionDetailQuizTitle = document.getElementById("submission-detail-quiz-title");

            submissionDetailSummary.innerHTML = '<p class="text-slate-600">Loading details...</p>';
            submissionDetailQuestions.innerHTML = '';
            submissionDetailQuizTitle.textContent = "Loading...";

            try {
                const response = await fetch(`/api/submission/${submissionId}/details`);
                const result = await response.json();

                if (result.success) {
                    const summary = result.summary;
                    const details = result.details;

                    submissionDetailQuizTitle.textContent = summary.quiz_title + " Details";
                    submissionDetailSummary.innerHTML = `
                        <p class="font-bold text-base">User: ${summary.user_email}</p>
                        <p class="text-xl font-playfair font-bold text-blue-600 mt-2">Score: ${summary.score}/${summary.total_questions_in_quiz} (${summary.percentage.toFixed(2)}%)</p>
                        <p class="text-base text-slate-700">${summary.feedback_text}</p>
                        <p class="text-xs text-slate-500 mt-2">Submitted: ${new Date(summary.submitted_at).toLocaleString()}</p>
                    `;

                    details.forEach(qDetail => {
                        const qDiv = document.createElement("div");
                        qDiv.className = `p-4 mb-3 rounded-lg border ${qDetail.is_correct ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                        qDiv.innerHTML = `
                            <p class="font-semibold">${qDetail.question_text}</p>
                            <p class="text-sm mt-1">Your Answer: <span class="${qDetail.is_correct ? 'text-green-700' : 'text-red-700'} font-medium">${qDetail.user_selected_answer_text}</span></p>
                            <p class="text-sm">Correct Answer: <span class="text-green-700 font-medium">${qDetail.correct_answer_text}</span></p>
                        `;
                        submissionDetailQuestions.appendChild(qDiv);
                    });

                } else {
                    submissionDetailSummary.innerHTML = `<p class="text-red-500">Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error("Error fetching submission details:", error);
                submissionDetailSummary.innerHTML = '<p class="text-red-500">Failed to load submission details. Please try again.</p>';
            }
        }

        function printResults() {
            if (!window.latestQuizResultForPrinting) {
                showModal("Error", "No quiz results available for printing. Please complete a quiz first.");
                return;
            }

            const { email, score, totalQuestions, percentage, feedback, title, detailed_results } = window.latestQuizResultForPrinting;

            let printContent = `
                <div style="font-family: 'Roboto', sans-serif; padding: 20px; color: #1f2937;">
                    <h1 style="font-family: 'Playfair Display', serif; font-size: 28px; text-align: center; margin-bottom: 20px;">QuizFlow Results: ${title}</h1>
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #e5e7eb;">
                        <p style="font-size: 18px; font-weight: 500; margin-bottom: 5px;">User: ${email}</p>
                        <p style="font-size: 36px; font-weight: 700; color: #2563eb; margin-bottom: 5px;">Score: ${score}/${totalQuestions}</p>
                        <p style="font-size: 20px; color: #4b5563; margin-bottom: 10px;">${percentage.toFixed(2)}%</p>
                        <p style="font-size: 16px; font-weight: 500; padding: 8px; border-radius: 4px; ${percentage >= 60 ? 'background-color: #d1fae5; color: #065f46;' : 'background-color: #fee2e2; color: #991b1b;'}"}>${feedback}</p>
                    </div>
                    <h2 style="font-family: 'Playfair Display', serif; font-size: 22px; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px;">Question Breakdown</h2>
            `;

            detailed_results.forEach((item, index) => {
                const bgColor = item.is_correct ? '#ecfdf5' : '#fef2f2'; // light green vs light red
                const borderColor = item.is_correct ? '#a7f3d0' : '#fecaca'; // slightly darker green vs red
                const textColor = item.is_correct ? '#065f46' : '#991b1b'; // darker green vs red

                printContent += `
                    <div style="background-color: ${bgColor}; border: 1px solid ${borderColor}; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${index + 1}. ${item.question_text}</p>
                        <p style="font-size: 14px; margin-bottom: 4px;">Your Answer: <span style="color: ${textColor}; font-weight: 500;">${item.user_selected_answer_text}</span></p>
                        <p style="font-size: 14px;">Correct Answer: <span style="color: #065f46; font-weight: 500;">${item.correct_answer_text}</span></p>
                    </div>
                `;
            });

            printContent += `</div>`; // Close main content div

            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Quiz Results</title>
                        <style>
                            body { font-family: 'Roboto', sans-serif; margin: 20px; }
                            h1, h2 { font-family: 'Playfair Display', serif; }
                            /* Basic print styles */
                            @media print {
                                body { font-size: 10pt; }
                                h1 { font-size: 24pt; }
                                h2 { font-size: 18pt; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            } else {
                showModal("Error", "Could not open print window. Please allow pop-ups for this site.");
            }
        }

        function showMainLoginOrQuizView() {
            if (currentUserEmailGlobal) {
                // If logged in, assume they want to restart quiz or see past submissions
                // For simplicity here, we go back to login screen but keep user data
                // In a real app, you'd likely go to a dashboard or quiz selection screen
                toggleAuthView('login');
                // Reset some quiz state for a new attempt
                currentQuestionIndex = 0;
                perQuestionAnswers = [];
                quizActive = false;
                clearInterval(perQuestionTimer);
                timerDisplay.textContent = "00:00"; // Reset timer display
                progressBarFill.style.width = '0%';
                progressText.textContent = '0%';
            } else {
                toggleAuthView('login');
            }
        }

        function logoutAndRestart() {
            currentUserEmailGlobal = "";
            currentUserIdGlobal = null;
            quizDataStore = [];
            currentQuestionIndex = 0;
            perQuestionAnswers = [];
            quizActive = false;
            userFocusLossCount = 0;
            window.latestQuizResultForPrinting = null;
            clearInterval(perQuestionTimer);
            timerDisplay.textContent = "00:00"; // Reset timer display
            progressBarFill.style.width = '0%';
            progressText.textContent = '0%';
            toggleAuthView('login');
        }

    </script>
</body>
</html>